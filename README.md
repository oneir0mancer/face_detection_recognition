# face_detection_recognition

Этот репозиторий содержит код к дипломной работе по распознаванию лиц.

## Гипотеза
* детектирование лица можно совместить с идентификацией, 
т.е. использоват одни и те же признаки, извлеченные нейронной сетью,
и для детектирования изолражения, и для его классификации.
* подобно подходу, используемому в метрической классификации, можно
получать embedding для детектированных лиц, который в дальнейшем
можно использовать для идентификации, измеряя "похожесть" (расстояние) между двумя embedding-ами.

## Архитектура сети
![Схема](docs/scheme.png)

В качестве сверточной сети для извлечения признаков используется ResNet34. 
На выхоре из avgpool слоя получается тензор признаков размера 5x5x512.

Regression head получает из него тензор размера 5x5x(num_ancors\*5), описывающий каждый bounding box.
4 числа описывают размеры и положение bbox-а, 1 число - уверенность в нахождении в нем лица.

Положение bbox - смещение его центра относительно верхнего левого угля клетки.
Размеры bbox - коэффициенты экспоненциатьного преобразования относительно одной из
предопределенных зарание anchor box.

![Здесь формула, описывающая преобразование](docs/bbox.png)

Classification head получает тензор признаков тензор размера 5x5x(num_ancors\*512).
Это эмбеддинги лиц, находящихся в bbox-ах. Они передаются классификатору, и он возвращает
тензор размера 5x5x(num_ancors\*num_classes), содержащий вероятности классов.

## Описание процесса обучения
Сеть обучается тем же методом, что используется при обучении нейронной сети YOLO.

Функция потерь - комбинированная, представляет собой сумму smooth L1 loss, бинарной кросс-энтропии и кросс-энтропии.
Она имеет такую же структуру, что и функция потерь из статьи YOLO:

![Здесь формула, описывающая loss](docs/loss.png)

## План экспериментов
### Экcперимент 1
Этот эксперимент призван выяснить, насколько изменится точность распознавания лиц,
если решать комбинированную задачу детектирования и распознавания.

Описанная нейронная сеть была обучена детектировать и классифицировать лица
на небольшом датасете из 285 субъектов, содержащем только одного человека на фотографии.

Обучающая выборка содержит 3277 изображений. Тестовая выборка содержит 651 изображение.
Размер изображений - 320 пикселей по меньшей стороне.

Для скавнения была обучена ResNet34 для классификации, а для детектирования использовался dlib.

Обе сети учились на случайных кропах 320x320.

Результаты:

|              | ResNet34 + dlib | This net |
| ------------ | --------------- | -------- |
| **Точность**     | 97.54%  | 98.15%  |
| **Средний IoU**  | 79.82%  | 78.88%  |
| **FPS**          | 6.5  | 34.5  |

### Экcперимент 2

Этот эксперимент призван выяснить, годится ли представление, которое сель выучивает на последнем слое,
е качестве embedding-а для лица.

### Экcперимент 3

Датасет модифицируется для обучения на случае нескольких человек на фото. Для этого несколько 
фотографий разных субъектов склеиваются в одну.

### Экcперимент 4

Модифицируется архитектура сети - добавляется декодер из нескольких deconvolution-слоев, 
тем самым увеличивая размер выходной матрицы до 19х19. Добавляются bridge connections, которые
конкатенируют ответы ранних слоев сети к поздним слоям декодера. Добавляется распознавание на разных scale-ах:
5х5, 11х11, 19х19.
